<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Receipt Processor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .auth-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .auth-button {
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .auth-button:hover {
            background: #0056b3;
        }
        .google-button {
            padding: 12px;
            background: #db4437;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .google-button:hover {
            background: #c23321;
        }
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }
        .divider span {
            background: #f9f9f9;
            padding: 0 15px;
            color: #666;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
        }
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success-message {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h1 id="auth-title">Sign In</h1>
        
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
        
        <form class="auth-form" id="auth-form">
            <input type="email" id="email" class="auth-input" placeholder="Email" required>
            <input type="password" id="password" class="auth-input" placeholder="Password" required>
            <button type="submit" class="auth-button" id="auth-button">Sign In</button>
        </form>
        
        <div class="divider">
            <span>or</span>
        </div>
        
        <button class="google-button" id="google-sign-in">
            <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2.04a4.8 4.8 0 0 1-2.7.75c-2.087 0-3.86-1.408-4.492-3.304h-2.681v2.088A7.918 7.918 0 0 0 8.98 17z"/>
                <path fill="#FBBC05" d="M4.49 10.43a4.795 4.795 0 0 1 0-3.06V5.272H1.808a7.918 7.918 0 0 0 0 7.11l2.682-2.05z"/>
                <path fill="#EA4335" d="M8.98 4.72c1.17 0 2.23.4 3.06 1.2l2.3-2.3A7.918 7.918 0 0 0 8.98 1 7.918 7.918 0 0 0 1.98 6.62l2.68 2.09A4.8 4.8 0 0 1 8.98 4.72z"/>
            </svg>
            Continue with Google
        </button>
        
        <div class="auth-toggle">
            <p id="toggle-text">Don't have an account? 
                <a href="#" id="toggle-link">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCQ_jGHZ0-EUwqAKN1q61rjRsfnjeoem20",
            authDomain: "receipts-ocr-3381a.firebaseapp.com",
            projectId: "receipts-ocr-3381a",
            storageBucket: "receipts-ocr-3381a.firebasestorage.app",
            messagingSenderId: "865796812966",
            appId: "1:865796812966:web:daddc0cfa0fe8385970467",
            measurementId: "G-EPMKJ5VG6D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // Configure Google provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');
        
        // Set custom parameters to help with COOP issues
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        let isLogin = true;

        // DOM elements
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const toggleText = document.getElementById('toggle-text');
        const toggleLink = document.getElementById('toggle-link');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        // Toggle between login and signup
        function setupToggleLink() {
            const toggleLink = document.getElementById('toggle-link');
            toggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLogin = !isLogin;
                
                if (isLogin) {
                    authTitle.textContent = 'Sign In';
                    authButton.textContent = 'Sign In';
                    toggleText.innerHTML = 'Don\'t have an account? <a href="#" id="toggle-link">Sign up</a>';
                } else {
                    authTitle.textContent = 'Sign Up';
                    authButton.textContent = 'Sign Up';
                    toggleText.innerHTML = 'Already have an account? <a href="#" id="toggle-link">Sign in</a>';
                }
                
                // Re-setup the toggle link
                setupToggleLink();
                hideMessages();
            });
        }
        
        // Initial setup
        setupToggleLink();

        // Handle form submission
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessages();
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            try {
                if (isLogin) {
                    // Sign in existing user
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    showSuccess('Successfully signed in!');
                    
                    // Get ID token and redirect to main app
                    const idToken = await userCredential.user.getIdToken();
                    localStorage.setItem('firebase_token', idToken);
                    
                    // Redirect to main app after short delay
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                    
                } else {
                    // Create new user
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    showSuccess('Account created successfully! Please sign in.');
                    
                    // Switch to login mode
                    isLogin = true;
                    authTitle.textContent = 'Sign In';
                    authButton.textContent = 'Sign In';
                    toggleText.innerHTML = 'Don\'t have an account? <a href="#" id="toggle-link">Sign up</a>';
                    setupToggleLink();
                    
                    // Clear form
                    emailInput.value = '';
                    passwordInput.value = '';
                }
            } catch (error) {
                showError(error.message);
            }
        });

        // Handle Google Sign-In
        document.getElementById('google-sign-in').addEventListener('click', async (e) => {
            e.preventDefault();
            hideMessages();
            
            try {
                const result = await auth.signInWithPopup(googleProvider);
                showSuccess('Successfully signed in with Google!');
                
                // Get ID token and redirect to main app
                const idToken = await result.user.getIdToken(true);
                console.log('Got Google ID token:', idToken.substring(0, 50) + '...');
                localStorage.setItem('firebase_token', idToken);
                
                // Redirect to main app after short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    // Don't show error for user cancellation
                } else if (error.code === 'auth/popup-blocked') {
                    showError('Popup was blocked. Please allow popups and try again.');
                } else {
                    showError(error.message);
                }
            }
        });

        // Monitor auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User is signed in:', user.email);
            } else {
                console.log('User is signed out');
                localStorage.removeItem('firebase_token');
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
    </script>
</body>
</html>